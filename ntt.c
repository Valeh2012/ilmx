#include <stdint.h>
#include "params.h"
#include "ntt.h"
#include "reduce.h"

const int64_t zetas[1024] = {
90108L,-1644158229929712121L,109702563867383382L,271274140991538981L,-243085343428186987L,1719190011215860699L,-657099914176171633L,1532242735275686501L,-1731563971289076340L,-2021418209444068375L,-1905521949629898280L,-871666913100549415L,294941618627881137L,-1670876602203037871L,-1847757195354803653L,959447663116954748L,51505227929077329L,-269526758641257376L,457850029092681219L,240536066433015880L,-2221005284772531631L,2065774936278797371L,-658825604430769457L,82815751093789474L,1846521868763806213L,830363131316344818L,1987885929627577882L,-297776191870637802L,-1777705932112478397L,-242850773886482063L,-795848877701730547L,1455403353503702857L,
-1778050586174231311L,746695044458305668L,401250577958352745L,1826764829752075549L,-968870733365777677L,463569886270112728L,2284170501992579690L,-2280454747399794501L,722769086613435106L,2005112617847700395L,150987956592254425L,-1196790550807551515L,888474491466825008L,170761880288923457L,432808394302836584L,579409637294701864L,553592301955860002L,735854985838171668L,1097746364599473118L,96093612316755081L,-1541203039443905516L,1720656560512104762L,-1043635884131434284L,719343782818499580L,1668840470058587376L,39231954981350284L,-2043003112692767480L,1771076158365277782L,-623398166563525211L,-1016737089423687562L,-298836401242225951L,773477097843826276L,
-45768067005156571L,-1867207701815336142L,-554614311894197569L,-213592279886143725L,-614994219218881726L,-1015431565470840991L,2168758775856657090L,-441265855161823916L,-1561585192162513106L,973764954888152812L,1110743251981684294L,743356657136178387L,-840260947664647817L,8059533455780994L,1572306907675649304L,1911615470911874700L,1352104897741785633L,126736994395646653L,2020606806152452847L,421137806706166707L,-1794697030849733120L,499267493731043209L,2181614971734925580L,-440480742466422358L,124156693384007457L,-32872117116595746L,-1721660603292544297L,-1499379181356230309L,435066898297668937L,-2263551815263983564L,-1553021751525249992L,1857753289757931806L,
-1863836102347246596L,693450270315709381L,-432755658154566891L,-1315134387947388566L,102957318211321341L,-1516376155651863746L,440208866811114004L,-1197692766162888244L,-1456055867503633625L,-1587348471201923565L,-1942094942389281296L,-754377778920432251L,2262874601222865733L,1069977860395390106L,-1690845065569244243L,-707198587921468288L,339886831119056064L,1114206711142102168L,-912300467331407968L,-2234463556345942899L,-1223649024080208304L,644617569569534291L,1219877614594841326L,-809915416384969657L,-117358411001548445L,1263186973513897673L,440706968513302213L,1319000365814948851L,607124189282228597L,-1723695020177726357L,1852335334408239742L,224566865062568604L,
1581844477713854439L,-194324680343737572L,-650267223267463931L,77329585677241888L,-742898610540953773L,-4526322765806801L,1328955823738113753L,-1609461841193421855L,-1476258475519460139L,1390659137782505380L,1169697320334508316L,202424840407232088L,126401473148154324L,-893635544479476166L,751488730039583109L,2206698972228964841L,-848978691074659717L,1923846332946148402L,1419537517995217395L,-227238296370355592L,134030822976607651L,1450451591951078101L,499800637574674511L,1504971560551482423L,-2090104310485081485L,-1206227511684169764L,-990430859728738508L,-631144457418858480L,-1802384570080960546L,1408302763164137227L,1820275560092839741L,-344107347564681264L,
1060371405745399263L,1460147302837066106L,-1611207083748970092L,2076946360029203431L,1971433907077104363L,-124122152748652455L,1251573533592662211L,595563878428131590L,-1939540382820612022L,-1526303270340585159L,1099252233744910446L,-2062308282599962008L,-498187638629532894L,-2118673361137536957L,10665469562296845L,-1675385667331186900L,79605607743420894L,1291866416482877916L,1611633316069022438L,1564437836073597918L,-1791379451602619778L,-170967181432649238L,-466314952138926320L,1669725483490904946L,-2165205583195600636L,-716379410423107516L,470469302948139663L,1036001452337386230L,-1188236205327082331L,107702243723285542L,-2183759947284615978L,-690992900168000623L,
1043782896129032875L,-895509263964810281L,-412668870261569101L,-1896115351155832378L,234862139049207583L,-317612203783317652L,1669266382873761184L,827305433177411891L,-1252227748770221596L,-638218387727195632L,1157174443651318529L,850334898713456799L,-2231064645312066928L,-2249401847739801334L,424023392830927799L,1318040297462381845L,1087022868629348138L,1826922825596526824L,-1784077517951212042L,701899286211778344L,6598148759482298L,-2178890326710406905L,-521784438448490158L,-1639814683756214668L,1540497385456171298L,1075102029571207641L,1046045879225971440L,-1004703257593702739L,1755068147035209784L,-1762761540975986364L,1627083827092863661L,1750962239615350993L,
-1374579378325524802L,1369110134399589773L,1766379331738150856L,-2131301451983179551L,-905547290251575971L,-2081061041007037558L,-634555264535632512L,-1140959058945789057L,1017098075482710409L,1971396028587150050L,-37295655217900461L,-774706798776366511L,224273195997236168L,-318324017722917472L,-1428074385875904954L,-1360476059901787603L,1816999970015774087L,-211989269992630081L,624813088680543561L,1074599207826236376L,1812741408542409618L,2090063756670853748L,-571494070019147208L,-1574727673218775050L,-1465206784642886417L,-1155050487983914176L,1744165053550325438L,2221944737479112105L,1539932798647270083L,2087300928045457598L,388463381732371380L,209820559865508777L,
-1781119343954500220L,-1226169172652110076L,-1939098905696069935L,472076395081582591L,-1895198787225345397L,174306459185359045L,1009742362534315424L,214629181289177182L,1832906432212568470L,-1063682952590409265L,-817390114095132593L,1181668014547709681L,784224578849184725L,-1133263695786181517L,1886905033718642996L,1196518416603251762L,-1058673610852355115L,-552364114475543380L,-2186640417653422166L,339806994245876306L,1135423697336270712L,2247432162449981528L,817072268952130202L,2070533332789396390L,-1344989123149840183L,1315331862474104566L,-1403820620222876991L,-1628281196210867647L,-2210328600758799885L,1616040168554058541L,905484067895144189L,701526224753067443L,
-94952841510300186L,-533667517805031774L,-1173841803799712925L,186652132636637505L,602905535404512007L,64188871035236361L,353186586276290242L,1923676916906289543L,-1638545661691072886L,-2123800444589985040L,1401119555869949616L,-1757151930894552724L,1481041871726012973L,-1879090586813283768L,-1394270645554773507L,-1629517378087134109L,387659899322945321L,-1354032634477550125L,-695964562414823824L,-754554740046591490L,1637841027358888032L,2105320092568937834L,-1604058471759170925L,1875849542709698671L,-1295771027426021346L,-2248775436645831315L,-659475957708829556L,2062149052194551890L,-2103943661387453652L,-2062728782200988631L,-2072314247244182719L,279960744999609440L,
1664995107281635147L,-1503353360499681957L,1879256316325864412L,714465250968441343L,-787249123910873894L,1569564881702771808L,1948382396288316471L,-1150730301768635307L,181647259985041326L,879963537734661379L,945074638232434023L,-292543983299792831L,748514912392317377L,-907613576813460212L,1299650836477486008L,-1469780520567396221L,-34553174773761320L,-1672004075848390510L,-996923613819591537L,604795994542958801L,-265709971364886637L,-1696908356358111052L,-878269736357317505L,1527987417051553795L,-1750501720575769943L,1971103487984233930L,878606566932361406L,-396108382663265934L,97456849719767476L,-494969228606590729L,-764010313753936704L,-1853421809600869215L,
1463524619508597216L,2139770505478443172L,1786023561179240811L,-336794401096421640L,955197174724620884L,-1044437684178238079L,983464285691452656L,-1372533064734163082L,1898171912054692644L,-1138325017306987532L,2142134564574489315L,-1717203816846265017L,-1856415474273495159L,-1989669407493669049L,773377079043321080L,840735580870077569L,1728222852124673072L,-923426096297426528L,-1352099120249949371L,-426666103956501857L,-1907308341901333810L,-1483425032167289420L,1683012929321691259L,1221477565724842251L,1045606343016231962L,-1113621041560196415L,1909880001749000652L,-606465933199550286L,-1143959695730326271L,-2062467040019914823L,-2227896685408444839L,1055444475683903299L,
-1668143622913985859L,653312437770076492L,-69372389379499045L,1032720682897502357L,-295792731492154996L,-546386453214302616L,344098565438445305L,-1532524811548988275L,-1250522327691788017L,1167730364911594101L,-669001418601002073L,478825097780568969L,-1024270641666649863L,-1189118701571493419L,301364420854519557L,161268594841747471L,159045303989932693L,1959827681266403490L,1292956683032351043L,-1978529030824705065L,1243200259338385157L,2257592978931475507L,62264132029006329L,-247404737218814374L,2204344724428829648L,-600550521525458845L,589184606284955672L,2229006419362322626L,1824684729091959479L,-1213645359167871324L,-859820463885598673L,2220446278438179324L,
-1112476301377979954L,480149406986946792L,1103916719699121180L,-131547578548207151L,-291692323963155995L,173640795888839075L,917853232032934211L,-1724665410543760513L,585908770249483239L,1910878687368625055L,255054906383761337L,-2078979480388903474L,-2125185439921470041L,-798964444232508959L,-845830339793057963L,-1788632532048548973L,-325375553511143457L,1902125331873015885L,-798763700226713467L,2162859522694790698L,2267818122301744819L,-1608756113916423163L,1507816496102968554L,2129356302011357403L,2220684085133111716L,-439657863036668761L,-1559989705428112879L,369979034213077260L,434724907911453263L,1184302002027345514L,-1634363779388416884L,-2057433425384269258L,
-1487408694244438871L,1863796395971979172L,1557702188734470614L,-2208858709308818497L,1271444784250058428L,-1163575758904641065L,1589819717208994588L,1596199082790990886L,-412886654852968932L,-932892018879320801L,1234284718119135434L,2260682174735118397L,-1758566154453071566L,903965737075653726L,2177118768074203539L,532846951827681227L,1328887559835181113L,-2146849778614121413L,-516071810728443616L,506500166317092314L,1167818121956609976L,1425456265962979100L,827393602523334768L,1116165752725425555L,-2000700380589047372L,-1711582117015695384L,643404910972973189L,-1969448635431527860L,2133063928710205178L,145302568176277502L,-219512679294833309L,-2139236041590099101L,
-1902235294263089884L,2296383875236988446L,1679520776254125985L,1365121053553850104L,1674328886428546835L,558076022607144507L,-116701611896576209L,1528767909215272665L,-1421488217761863891L,1451484980424534180L,609911660335842067L,-1508631912608490395L,1967291576493893770L,-954915681838791231L,-1848571795691654525L,-1346964935849824414L,-1154089490819632906L,1671460168439688624L,-880865178835207633L,-842323675491659295L,-1663636797776621924L,-1585913247660245187L,-1989630916157162572L,-1052238333932575510L,1571416031833974348L,684201997385729468L,-1724563254098375482L,1400903568373952608L,-272575928081586674L,-1948695385558941439L,1963885836571232034L,-1513910998324548291L,
1432675258783044553L,109216001604985666L,1425354764113544271L,-33944677150300486L,-2004024580130099092L,597981262688578284L,1662823914832247017L,-2026005705084416438L,2167432364704684600L,-2108632854085365402L,-1100788801426932996L,400344979144160023L,-1349991752388170126L,-1376481847321203516L,-440467363111287264L,1511322890413345978L,129968686307906526L,47336089680695437L,159282920008789496L,-427921562183555711L,-1734013514653942890L,-352502726594773874L,1838298185815769318L,192537914655846219L,-12502791397461454L,1397973063746471243L,-609055830438165824L,923840673045371955L,517821191519018239L,-571906260289362333L,2234189023749765735L,1505273336907906260L,
2110771824070395308L,-2177786714228548501L,-1887870554119724253L,-238609519289268895L,-1409161698091387610L,-1937148153395216234L,-113171744848946816L,1094201248377441579L,2209400091845249890L,667382304685991917L,-1601850527453172405L,-1437931371597579259L,1072600476397805426L,1676900925863387127L,1902782743608414807L,522268566416518121L,-1821773891075063116L,-358382682018051998L,-1751524117374347526L,2267567434078015574L,1232696396025859926L,-839969472934324561L,2126267130031705560L,-25501605880898318L,-338664352247099062L,-395782318626146205L,974532528472948455L,-1515051043086770509L,-615848101000673919L,1285934987527646492L,-904808237016180300L,304919675619251117L,
-675778982117028536L,244132703322140516L,924645180276336773L,319698576931103518L,1855596335736698146L,1910713833563277305L,-1692576850393536445L,-229665719972928998L,419930316113941014L,-1620897988068252542L,284732294991739895L,574409484871370742L,1164730201624888650L,-1002042070363357407L,1404610871544194824L,856424961804623027L,1988294849444556576L,1056978282386281067L,785464011105256780L,-2112457644166396234L,1106100173599059023L,-908332806145780337L,-1554726322750642939L,-1472336709140178640L,-1817900682230899764L,-1301290009969474667L,-314420621388706402L,-1399581971899099528L,-792547143292549016L,1103864747084963032L,2063259904215727395L,-2053774050853224910L,
1951022913863789250L,-1255859940141952031L,-637299784388692556L,887227691055950194L,1896324986860550418L,-7278518198372265L,-133461379380884039L,2280790261322468886L,1470491975704274167L,-1755705906841151731L,2037221762023684955L,-333967790834489848L,-378620252217383009L,-819880376719078617L,1823073658858699274L,-2288718592506386470L,230551568811762145L,-1344307886099372532L,-763098792292890865L,-918394625346819427L,-378242468322738487L,-1203745477854801625L,-941329189612564047L,970471637982819053L,-1233741377157852238L,-263195868498950365L,-923024508168076319L,311185191597916533L,-710192388170254020L,-809979842086770456L,2122708638104652722L,-816488130088850579L,
4610874640159110L,2037412056624718824L,-1998811456641266698L,1642955682128474563L,1492032352327685174L,1948657286036884946L,-653701429127154079L,756683773195987386L,1353696714458928935L,-109137689366035631L,-156739917973292275L,-272485694642205549L,1511203464967099037L,-1078484888815563981L,46025563602628969L,-878794743314147761L,1329831178157030503L,495299378568374894L,120259502318114912L,1328118329418339038L,918061394384249823L,-1008394455643762416L,-1161847639116544462L,1817499775965116852L,-1850365436344436855L,228745802068323630L,1364558372557674378L,-2186474434861149766L,1029797379469018656L,-82773506475798596L,130782832778266439L,-303926759615322864L,
-976520291441795187L,-1880805660521184213L,-235186064073252475L,457775589131460607L,-726279715729793482L,-507364347470224025L,2258001619133238991L,1709135896671595318L,676871381163241423L,1471326608827742345L,-1920961015820570975L,-2277527497165409104L,-2275944508100822649L,925567157216725539L,-120485875316543269L,-1318780604479322481L,688979204912502604L,-611986188017688770L,-106678288349787078L,-2037564131917102166L,233724549900836075L,-683521854732711220L,-2156109102249691338L,-136493008162511670L,1491175881606923520L,-1744049672788645601L,-1556657182881338563L,1130908602179372874L,-1035850223075197507L,-1508135616847957690L,649886050614593361L,-2110596265237706007L,
1920558581409309102L,-528226471031557181L,1549857879605963155L,-1945480991391871243L,-5562508468853080L,1007713838219356166L,-2124082933682909935L,-1402695114293251619L,-980066669852815359L,-664332691290631778L,1360995608599970353L,124562327819646211L,-628108124496228650L,-1038853004270004309L,1249244927676828003L,-312035001566429160L,1758745853823908395L,-385866148051260810L,1079307629031183368L,591475766432962273L,1062267505367941908L,-1081011472203049663L,621775646583539278L,-1523927584568823020L,-1155680660731457673L,-552820127388255864L,-296876795488037297L,-577982787735159221L,1898252619050492263L,1568279599307653753L,-1634152171862894050L,-659920681668334799L,
-133271448287191550L,1735879186482858768L,679878505888328126L,69285644994926164L,1935670141656888096L,566351197240574616L,507814274588864104L,1864772827173095241L,-331110792275200331L,-59932165360767061L,-753726097332462543L,-1383615779674072712L,-1851472944468077684L,-439860393549463968L,929543413389577194L,919441184847613309L,-463515401529558541L,2235877187143300046L,-269779052806506703L,-257610586630413861L,-779536847057085360L,-977370027797900374L,-2294586620857015734L,-329909616735458181L,-1385198298168774665L,1707395528019178300L,1842161235786331448L,-531748436073708060L,-855500278250348192L,-97687520681639260L,-1725432029668995107L,1086824203886492661L,
-571640118635024584L,827376373170957990L,-1711569882799211164L,-2020108807205335946L,-944988970893843055L,-11995365169120970L,731608957355603080L,1488180979833014690L,1114535760831647430L,-204226298421739945L,1380875463161406921L,-2205523312928776523L,1807098616705443016L,106055921837218435L,-63182849717476215L,-1642295963918386717L,814672295385860259L,-1269125405346400070L,-1009899313393666671L,-1018864709114671292L,797571194145087302L,-381909917186384988L,1041416500116902861L,2035645091827141976L,750015741101253720L,1513618289991151465L,1027192595077010523L,-1502207698293455962L,355233019923610382L,288115053467985574L,1077384112474664512L,1877893690128796752L,
-625738251577276540L,-814522334125971524L,931674243378539760L,1671605380397392637L,-844880300314209882L,-1881096276911946135L,-1672447728446662378L,1787085025455523240L,-131613885069009541L,1368277771606577210L,122779564059028727L,-1911684099481651630L,2189152530742630234L,-2051093545522598721L,-1536643756777485179L,-545914839630974931L,2171490947894964632L,2198336314196352733L,1220482010982104321L,-521312108214038544L,100643965490471310L,-1142689605440419980L,2013180668811053535L,1987402487684680810L,1062522269447629374L,-254132418294486851L,-62536001990691802L,-1644569349631279727L,-130311095225209800L,694984072986665861L,-1385663355938822966L,1445599373635481583L,
211072254141803077L,-472236810978905591L,2069257514880629204L,-285858984692535439L,830303994660922059L,956913097635419157L,406507351847419249L,578974193258345011L,-14170330308228055L,721295516436088198L,1486351822876409802L,-1533228353461465128L,1798173975098551571L,-2064634453334046306L,-1059261103815441989L,-58187951116433517L,-1422201620995971046L,-1898937816014248272L,1382580208475423292L,-1918201413098828877L,-805252620515301321L,-2282364087463653486L,-1587269394381176714L,1615502084200248260L,1953779463405593210L,278983350829280019L,-752888295513985147L,-1263837401969402460L,-2010112561942723922L,1479497860971114282L,-1450936815176951196L,-989834093154311928L,
-2117939377430613188L,-2281151670378611140L,1723902659749664194L,1429987402915752583L,-2145992921871878790L,-432645193366795413L,-42332158969188058L,2299891607664935313L,-67262585238836261L,-1971777313059478196L,2289189131563578606L,361235371471905203L,1740991342589678285L,1279116203822361008L,1211262080129289764L,312509725705618000L,483847181896263668L,-684025752960863980L,1366538631200484782L,2282626487258983233L,-780098714184030175L,-82247465486506941L,198521919520242200L,208126122704650798L,-1107866976079296943L,1009895843068327069L,-2042222459119640914L,1260279003020068660L,2002537643910081157L,1285036353382332130L,-1629508973591108267L,724888019765129203L,
2279483900919054701L,-1141948845676576038L,2166749739498794714L,806318022975415321L,-54629263850979884L,-28171142964659806L,-611495148452775397L,317794474158724270L,1640585159107522664L,1155321165395749941L,2193222545835605403L,878695817761278570L,-1153491418100096033L,-2275007458491762626L,770153755681951795L,1063636551130137305L,-1587329403059187429L,-1128781546261796458L,-1386106310753729189L,930055896985096459L,-402735974495047753L,21143012335892859L,1808407928077510074L,1460561537239303751L,990750271868530187L,895118806306284266L,995482259854091255L,1531814992298195353L,1786054168123071947L,2083870794592356789L,-610554710526679799L,-1211772544636941324L,
1408004654433121034L,1383345157883580791L,-2113902848998430904L,-1465428714034819334L,116893723128457376L,2200013158268706779L,308469682230489611L,-640535653211903001L,-486800533855609978L,-294526494392623785L,-58881749150243167L,-992951112193317487L,-890783261728722574L,-2090501481732265977L,2265623931702868083L,1785176174693238051L,-1678039927065442047L,-571329805719147059L,593535344167436020L,-643181661482874816L,-350234036613435193L,-2159677179401388697L,649717466296023596L,-1494897987732093282L,2190788521461046190L,-842742376504437549L,-921300891749029341L,885596332732590376L,2184772793933281207L,1667039972684206026L,210418956527299139L,1287408195645614945L,
-1691730238953839570L,-806976420285135725L,207186653274121559L,-1373337285426294680L,1290972711109573985L,-1111776547270565530L,-1202605949486207953L,1130663583349516510L,-192520724916957003L,-567379059749605813L,340686871558570968L,2054619570407372564L,1349227747828481696L,-1990398541459347995L,-1175330061320964002L,-1599904094217799L,824804545935616092L,-714606864016172478L,-1874578165431671393L,-1459053440320803465L,601553364349125585L,-1594955218580909702L,-1727942752832902189L,1350089275060841309L,1403553666349373644L,-1718794983331768823L,-1042109268628701735L,1789714122879043246L,1969429405272352683L,-1643990486499704132L,498740889828027941L,1315226051183671606L,
2234791148383540562L,1383332671733015275L,-1290379835541039598L,-1474191968288572065L,1370375794345712905L,-589465865996457645L,2303703125404513160L,473371609096652370L,-393101240994488777L,-2023103180755668398L,219614310623129564L,-2137175221722998182L,-134399670927117252L,-1235066572103745528L,-1674537335207156688L,-1698015357241393234L,-2247276348566868315L,-1003486962050492805L,518874994038483259L,161348624522050839L,-806968678980015610L,-1764462177444938813L,651938752413492478L,-2103629313519968067L,1579504520014421352L,1320807857370624919L,466326327975816556L,838188466760572901L,1354677013379888054L,-2240470912997498315L,277803388086818468L,-296155667002318479L,
};

/*************************************************
* Name:        fqmul
*
* Description: Multiplication followed by Montgomery reduction
*
* Arguments:   - int64_t a: first factor
*              - int64_t b: second factor
*
* Returns 16-bit integer congruent to a*b*R^{-1} mod q
**************************************************/
int64_t fqmul(int64_t a, int64_t b) {
  return montgomery_reduce((__int128)a*b);
}

/*************************************************
* Name:        ntt
*
* Description: Inplace number-theoretic transform (NTT) in Rq.
*              input is in standard order, output is in bitreversed order
*
* Arguments:   - int64_t r[4096]: pointer to input/output vector of elements of Zq
**************************************************/
void ntt(int64_t r[PQMX_N]) {
  unsigned int len, start, j, k;
  int64_t t, zeta;

  k = 1;
  for(len = 2048; len >= 4; len >>= 1) {
    for(start = 0; start < 4096; start = j + len) {
      zeta = zetas[k++];
      for(j = start; j < start + len; j++) {
        t = fqmul(zeta, r[j + len]);
        r[j + len] = barrett_reduce(r[j]) - t;
        r[j] = barrett_reduce(r[j]) + t;
      }
    }
  }
}

/*************************************************
* Name:        invntt_tomont
*
* Description: Inplace inverse number-theoretic transform in Rq and
*              multiplication by Montgomery factor 2^16.
*              Input is in bitreversed order, output is in standard order
*
* Arguments:   - int16_t r[4096]: pointer to input/output vector of elements of Zq
**************************************************/
void invntt(int64_t r[PQMX_N]) {
  unsigned int start, len, j, k;
  int64_t t, zeta;
  const int64_t f =  4539628424397366945L; // mont^2/1024

  k = 1023;
  for(len = 4; len < PQMX_N; len <<= 1) {
    for(start = 0; start < PQMX_N; start = j + len) {
      zeta = zetas[k--];
      for(j = start; j < start + len; j++) {
        t = r[j];
        r[j] = barrett_reduce(t + r[j + len]);
        r[j + len] = barrett_reduce(r[j + len] - t);
        r[j + len] = fqmul(zeta, r[j + len]);
      }
    }
  }
  for(j = 0; j < PQMX_N; j++)
    r[j] = fqmul(r[j], f);

}

/*************************************************
* Name:        basemul
*
* Description: Multiplication of polynomials in Zq[X]/(X^4-zeta)
*              used for multiplication of elements in Rq in NTT domain
*
* Arguments:   - int14_t r[4]: pointer to the output polynomial
*              - const int64_t a[4]: pointer to the first factor
*              - const int64_t b[4]: pointer to the second factor
*              - int64_t zeta: integer defining the reduction polynomial
**************************************************/
void basemul(int64_t r[4], const int64_t a[4], const int64_t b[4], int64_t zeta)
{
  int64_t tmp, rr[4];
  
  rr[0]  = fqmul(a[0], b[0]);
  tmp   = fqmul(a[1], b[3]);
  rr[0] += fqmul(tmp, zeta);
  tmp   = fqmul(a[2], b[2]);
  rr[0]  = barrett_reduce(rr[0]) + fqmul(tmp, zeta);
  tmp   = fqmul(a[3], b[1]);
  rr[0]  = barrett_reduce(rr[0]) + fqmul(tmp, zeta);
  
  rr[1]  = fqmul(a[0], b[1]);
  rr[1]  += fqmul(a[1], b[0]);
  tmp   = fqmul(a[2], b[3]);
  rr[1]  = barrett_reduce(rr[1]) + fqmul(tmp, zeta);
  tmp   = fqmul(a[3], b[2]);
  rr[1]  =  barrett_reduce(rr[1]) + fqmul(tmp, zeta);

  rr[2]  = fqmul(a[0],b[2]);
  rr[2] += fqmul(a[1],b[1]);
  rr[2]  = barrett_reduce(rr[2]) + fqmul(a[2],b[0]);
  tmp   = fqmul(a[3], b[3]);
  rr[2]  = barrett_reduce(rr[2]) + fqmul(tmp, zeta);

  rr[3]  = fqmul(a[0],b[3]);
  rr[3]  = barrett_reduce(rr[3]) + fqmul(a[1],b[2]);
  rr[3]  = barrett_reduce(rr[3]) + fqmul(a[2],b[1]);
  rr[3]  = barrett_reduce(rr[3]) + fqmul(a[3],b[0]);
  
  r[0] = rr[0];
  r[1] = rr[1];
  r[2] = rr[2];
  r[3] = rr[3];
}

/*************************************************
* Name:        scalar_field_mul
*
* Description: Scalar multiplication of a polynomial in Zq[X]/(X^4-zeta)
*
* Arguments:   - int14_t r[4]: pointer to the output polynomial
*              - const int64_t a: scalar factor
*              - const int64_t b[4]: pointer to the input polynomial factor
**************************************************/
void scalar_field_mul(int64_t r[4], const int64_t a, const int64_t b[4]){
    unsigned int i;
    for(i=0;i<4;i++){
        r[i] = fqmul(a, b[i]);
        r[i] = fqmul(r[i], MONT2);
    }
}

